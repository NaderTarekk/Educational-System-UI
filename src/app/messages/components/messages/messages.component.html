<!-- src/app/pages/messages/messages.component.html -->
<div class="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8" dir="rtl">

    <!-- Header Section -->
    <div class="mb-6 sm:mb-8">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">صندوق الرسائل</h1>
                <p class="text-gray-600">إدارة جميع الرسائل الواردة</p>
            </div>
            <div class="flex items-center gap-2">
                <button
                    class="px-4 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:shadow-xl hover:scale-105 transition-all duration-300 font-bold text-sm sm:text-base flex items-center justify-center gap-2">
                    <i class="fas fa-sync-alt"></i>
                    <span class="hidden sm:inline">تحديث</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-2xl p-6 border border-blue-100 hover:shadow-lg transition-all cursor-pointer"
            (click)="selectedFilter = 'all'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">إجمالي الرسائل</p>
                    <p class="text-3xl font-bold text-gray-800">{{messages.length}}</p>
                </div>
                <div class="w-14 h-14 bg-blue-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-envelope text-blue-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-6 border border-red-100 hover:shadow-lg transition-all cursor-pointer"
            (click)="selectedFilter = 'unread'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">غير مقروءة</p>
                    <p class="text-3xl font-bold text-gray-800">{{unreadCount}}</p>
                </div>
                <div class="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-envelope-open text-red-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-6 border border-amber-100 hover:shadow-lg transition-all cursor-pointer"
            (click)="selectedFilter = 'starred'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">مميزة بنجمة</p>
                    <p class="text-3xl font-bold text-gray-800">{{starredCount}}</p>
                </div>
                <div class="w-14 h-14 bg-amber-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-star text-amber-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-6 border border-orange-100 hover:shadow-lg transition-all cursor-pointer"
            (click)="selectedFilter = 'high'">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">عاجلة</p>
                    <p class="text-3xl font-bold text-gray-800">{{highPriorityCount}}</p>
                </div>
                <div class="w-14 h-14 bg-orange-100 rounded-xl flex items-center justify-center">
                    <i class="fas fa-exclamation-circle text-orange-600 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="bg-white rounded-2xl p-4 sm:p-6 mb-6 shadow-sm border border-gray-100">
        <div class="flex flex-col lg:flex-row gap-4">
            <!-- Search Input -->
            <div class="flex-1 relative">
                <input type="text" [(ngModel)]="searchTerm" placeholder="ابحث في الرسائل..."
                    class="w-full pr-12 pl-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 transition-all">
                <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>

            <!-- Filter Buttons -->
            <div class="flex gap-2 overflow-x-auto pb-2 lg:pb-0">
                <button (click)="selectedFilter = 'all'" [class.bg-blue-600]="selectedFilter === 'all'"
                    [class.text-white]="selectedFilter === 'all'" [class.bg-gray-100]="selectedFilter !== 'all'"
                    [class.text-gray-700]="selectedFilter !== 'all'"
                    class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap transition-all hover:scale-105">
                    الكل
                </button>
                <button (click)="selectedFilter = 'unread'" [class.bg-red-600]="selectedFilter === 'unread'"
                    [class.text-white]="selectedFilter === 'unread'" [class.bg-gray-100]="selectedFilter !== 'unread'"
                    [class.text-gray-700]="selectedFilter !== 'unread'"
                    class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap transition-all hover:scale-105">
                    غير مقروءة
                </button>
                <button (click)="selectedFilter = 'starred'" [class.bg-amber-600]="selectedFilter === 'starred'"
                    [class.text-white]="selectedFilter === 'starred'" [class.bg-gray-100]="selectedFilter !== 'starred'"
                    [class.text-gray-700]="selectedFilter !== 'starred'"
                    class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap transition-all hover:scale-105">
                    مميزة
                </button>
                <button (click)="selectedFilter = 'high'" [class.bg-orange-600]="selectedFilter === 'high'"
                    [class.text-white]="selectedFilter === 'high'" [class.bg-gray-100]="selectedFilter !== 'high'"
                    [class.text-gray-700]="selectedFilter !== 'high'"
                    class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap transition-all hover:scale-105">
                    عاجلة
                </button>
            </div>
        </div>
    </div>

    <!-- Messages List -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="divide-y divide-gray-100">
            <div *ngFor="let message of filteredMessages" (click)="viewMessage(message)"
                class="p-4 sm:p-6 hover:bg-gray-50 transition-all cursor-pointer group relative"
                [class.bg-blue-50]="!message.isRead">

                <div class="flex items-start gap-3 sm:gap-4">
                    <!-- Avatar -->
                    <div class="relative flex-shrink-0">
                        <div
                            class="w-12 h-12 sm:w-14 sm:h-14 bg-gradient-to-br from-blue-500 to-purple-500 rounded-xl flex items-center justify-center text-white font-bold text-lg sm:text-xl">
                            {{message.senderName.charAt(0)}}
                        </div>
                        <div *ngIf="!message.isRead"
                            class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white">
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-gray-800 text-base sm:text-lg truncate"
                                    [class.font-extrabold]="!message.isRead">
                                    {{message.senderName}}
                                </h3>
                                <p class="text-xs sm:text-sm text-gray-500 truncate">{{message.senderEmail}}</p>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <span class="text-xs sm:text-sm text-gray-500 whitespace-nowrap">
                                    {{getTimeAgo(message.timestamp)}}
                                </span>
                                <button (click)="toggleStar(message, $event)"
                                    class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-amber-50 transition-all">
                                    <i class="fas fa-star text-base sm:text-lg"
                                        [class.text-amber-500]="message.isStarred"
                                        [class.text-gray-300]="!message.isStarred"></i>
                                </button>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-semibold text-gray-700 text-sm sm:text-base truncate"
                                [class.font-bold]="!message.isRead">
                                {{message.subject}}
                            </h4>
                            <span *ngIf="message.priority !== 'low'"
                                class="px-2 py-0.5 rounded-full text-[10px] sm:text-xs font-bold whitespace-nowrap"
                                [ngClass]="getPriorityColor(message.priority)">
                                {{getPriorityLabel(message.priority)}}
                            </span>
                        </div>

                        <p class="text-sm text-gray-600 line-clamp-2 mb-3">
                            {{message.content}}
                        </p>

                        <!-- Attachments -->
                        <div *ngIf="message.attachments && message.attachments.length > 0"
                            class="flex items-center gap-2 flex-wrap">
                            <div *ngFor="let attachment of message.attachments"
                                class="flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg text-xs sm:text-sm">
                                <i class="fas fa-paperclip text-gray-500"></i>
                                <span class="text-gray-700 font-medium">{{attachment.name}}</span>
                                <span class="text-gray-500">({{formatFileSize(attachment.size)}})</span>
                            </div>
                        </div>

                        <!-- Actions (Mobile) -->
                        <div class="flex items-center gap-2 mt-3 sm:hidden">
                            <button (click)="markAsRead(message, $event)"
                                class="flex-1 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors text-sm font-semibold">
                                <i class="fas" [class.fa-envelope-open]="!message.isRead"
                                    [class.fa-envelope]="message.isRead"></i>
                                {{message.isRead ? 'غير مقروءة' : 'مقروءة'}}
                            </button>
                            <button (click)="deleteMessage(message, $event)"
                                class="px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors text-sm font-semibold">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Actions (Desktop) -->
                    <div class="hidden sm:flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button (click)="markAsRead(message, $event)"
                            class="w-9 h-9 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors flex items-center justify-center"
                            [title]="message.isRead ? 'وضع علامة كغير مقروءة' : 'وضع علامة كمقروءة'">
                            <i class="fas" [class.fa-envelope-open]="!message.isRead"
                                [class.fa-envelope]="message.isRead"></i>
                        </button>
                        <button (click)="deleteMessage(message, $event)"
                            class="w-9 h-9 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors flex items-center justify-center"
                            title="حذف">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div *ngIf="filteredMessages.length === 0" class="text-center py-16">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg font-semibold">لا توجد رسائل</p>
                <p class="text-gray-400 text-sm mt-2">جميع رسائلك ستظهر هنا</p>
            </div>
        </div>
    </div>
</div>

<!-- View Message Dialog -->
<div *ngIf="isViewDialogOpen && selectedMessage"
    class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 sm:p-6 md:p-8 animate-fadeIn"
    style="backdrop-filter: blur(10px);">

    <div
        class="view-dialog-scroll bg-white rounded-2xl sm:rounded-3xl shadow-2xl w-full max-w-3xl my-4 sm:my-6 md:my-8 max-h-[calc(100vh-2rem)] sm:max-h-[calc(100vh-3rem)] md:max-h-[calc(100vh-4rem)] overflow-y-auto animate-slideUp">

        <!-- Header -->
        <div
            class="sticky top-0 bg-gradient-to-r from-blue-600 to-purple-600 rounded-t-2xl sm:rounded-t-3xl p-4 sm:p-6 z-10">
            <div class="flex items-start justify-between gap-4">
                <div class="flex items-center gap-3 sm:gap-4 flex-1 min-w-0">
                    <div
                        class="w-12 h-12 sm:w-16 sm:h-16 bg-white/20 backdrop-blur-xl rounded-xl sm:rounded-2xl flex items-center justify-center text-white font-bold text-xl sm:text-2xl flex-shrink-0">
                        {{selectedMessage.senderName.charAt(0)}}
                    </div>
                    <div class="flex-1 min-w-0">
                        <h2 class="text-lg sm:text-xl font-bold text-white truncate">{{selectedMessage.senderName}}</h2>
                        <p class="text-white/80 text-xs sm:text-sm truncate">{{selectedMessage.senderEmail}}</p>
                    </div>
                </div>
                <button (click)="closeViewDialog()"
                    class="w-9 h-9 sm:w-10 sm:h-10 bg-white/20 hover:bg-white/30 rounded-lg sm:rounded-xl transition-all flex items-center justify-center group flex-shrink-0">
                    <i
                        class="fas fa-times text-white text-lg sm:text-xl group-hover:rotate-90 transition-transform duration-300"></i>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
            <!-- Subject -->
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800">{{selectedMessage.subject}}</h3>
                    <span *ngIf="selectedMessage.priority !== 'low'" class="px-3 py-1 rounded-full text-xs font-bold"
                        [ngClass]="getPriorityColor(selectedMessage.priority)">
                        {{getPriorityLabel(selectedMessage.priority)}}
                    </span>
                </div>
                <p class="text-sm text-gray-500">{{getTimeAgo(selectedMessage.timestamp)}}</p>
            </div>

            <div class="border-t border-gray-200"></div>

            <!-- Message Body -->
            <div class="prose max-w-none">
                <p class="text-gray-700 text-base sm:text-lg leading-relaxed whitespace-pre-wrap">
                    {{selectedMessage.content}}
                </p>
            </div>

            <!-- Attachments -->
            <div *ngIf="selectedMessage.attachments && selectedMessage.attachments.length > 0" class="space-y-3">
                <h4 class="text-base sm:text-lg font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-paperclip text-gray-500"></i>
                    المرفقات ({{selectedMessage.attachments.length}})
                </h4>
                <div class="space-y-2">
                    <div *ngFor="let attachment of selectedMessage.attachments"
                        class="flex items-center justify-between p-3 sm:p-4 bg-gray-50 rounded-xl border-2 border-gray-200 hover:border-blue-500 transition-all">
                        <div class="flex items-center gap-3 flex-1 min-w-0">
                            <div
                                class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-file text-blue-600 text-lg sm:text-xl"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800 text-sm sm:text-base truncate">{{attachment.name}}
                                </p>
                                <p class="text-xs sm:text-sm text-gray-500">{{formatFileSize(attachment.size)}}</p>
                            </div>
                        </div>
                        <button (click)="downloadAttachment(attachment)"
                            class="px-3 sm:px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all text-xs sm:text-sm font-semibold flex-shrink-0">
                            <i class="fas fa-download ml-1"></i>
                            تحميل
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-4 sm:p-6 rounded-b-2xl sm:rounded-b-3xl">
            <div class="flex flex-col sm:flex-row items-center gap-2 sm:gap-3">
                <button
                    class="w-full sm:flex-1 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-bold text-sm sm:text-base hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-reply"></i>
                    <span>رد</span>
                </button>
                <button
                    class="w-full sm:flex-1 py-3 bg-gradient-to-r from-green-600 to-emerald-700 text-white rounded-xl font-bold text-sm sm:text-base hover:shadow-xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-forward"></i>
                    <span>إعادة توجيه</span>
                </button>
                <button (click)="deleteMessage(selectedMessage, $event); closeViewDialog()"
                    class="w-full sm:w-auto px-4 sm:px-6 py-3 bg-white border-2 border-red-300 text-red-600 rounded-xl font-bold text-sm sm:text-base hover:bg-red-50 transition-all flex items-center justify-center gap-2">
                    <i class="fas fa-trash"></i>
                    <span>حذف</span>
                </button>
            </div>
        </div>
    </div>
</div>