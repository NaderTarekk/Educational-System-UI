<!-- src/app/pages/messages/messages.component.html -->
<div class="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8" dir="rtl">

    <!-- Header Section -->
    <div class="mb-6 sm:mb-8">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div *ngIf="!isAdmin">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">صندوق الرسائل</h1>
                <p class="text-gray-600">إدارة جميع الرسائل الواردة</p>
            </div>
            <div class="flex items-center gap-2">
                <!-- زر إرسال رسالة جديدة - للأدمن فقط -->
                <button *ngIf="isAdmin" (click)="openComposeDialog()"
                    class="px-4 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-green-600 to-emerald-700 text-white rounded-xl hover:shadow-xl hover:scale-105 transition-all duration-300 font-bold text-sm sm:text-base flex items-center justify-center gap-2">
                    <i class="fas fa-paper-plane"></i>
                    <span class="hidden sm:inline">رسالة جديدة</span>
                </button>
                <button (click)="loadMessages()" *ngIf="!isAdmin"
                    class="px-4 sm:px-6 py-2 sm:py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl hover:shadow-xl hover:scale-105 transition-all duration-300 font-bold text-sm sm:text-base flex items-center justify-center gap-2"
                    [disabled]="isLoading">
                    <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
                    <span class="hidden sm:inline">{{ isLoading ? 'جاري التحديث...' : 'تحديث' }}</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" *ngIf="!isAdmin">
        <!-- Total Messages -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg hover:shadow-xl transition-all cursor-pointer"
            (click)="onFilterChange('all')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm font-semibold mb-1">إجمالي الرسائل</p>
                    <h3 class="text-4xl font-bold">{{ totalCount }}</h3>
                </div>
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-envelope text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Unread Messages -->
        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-2xl p-6 text-white shadow-lg hover:shadow-xl transition-all cursor-pointer"
            (click)="onFilterChange('unread')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-red-100 text-sm font-semibold mb-1">غير مقروءة</p>
                    <h3 class="text-4xl font-bold">{{ unreadCount }}</h3>
                </div>
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-envelope-open text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Starred Messages -->
        <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg hover:shadow-xl transition-all cursor-pointer"
            (click)="onFilterChange('starred')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-amber-100 text-sm font-semibold mb-1">المفضلة</p>
                    <h3 class="text-4xl font-bold">{{ starredCount }}</h3>
                </div>
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-star text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- High Priority -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg hover:shadow-xl transition-all cursor-pointer"
            (click)="onFilterChange('high')">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm font-semibold mb-1">عاجلة</p>
                    <h3 class="text-4xl font-bold">{{ highPriorityCount }}</h3>
                </div>
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="fas fa-exclamation-circle text-3xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="bg-white rounded-2xl p-4 sm:p-6 mb-6 shadow-sm border border-gray-100" *ngIf="!isAdmin">
        <div class="flex flex-col sm:flex-row gap-4">
            <!-- Search -->
            <div class="flex-1 relative">
                <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" [(ngModel)]="searchTerm" (input)="onSearchChange()" placeholder="ابحث في الرسائل..."
                    class="w-full pr-12 pl-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-500 transition-all">
            </div>

            <!-- Filter Buttons -->
            <div class="flex gap-2 flex-wrap">
                <button (click)="onFilterChange('all')" [class.bg-blue-600]="selectedFilter === 'all'"
                    [class.text-white]="selectedFilter === 'all'" [class.bg-gray-100]="selectedFilter !== 'all'"
                    [class.text-gray-700]="selectedFilter !== 'all'"
                    class="px-4 py-2 rounded-xl font-semibold transition-all hover:scale-105">
                    الكل
                </button>
                <button (click)="onFilterChange('unread')" [class.bg-red-600]="selectedFilter === 'unread'"
                    [class.text-white]="selectedFilter === 'unread'" [class.bg-gray-100]="selectedFilter !== 'unread'"
                    [class.text-gray-700]="selectedFilter !== 'unread'"
                    class="px-4 py-2 rounded-xl font-semibold transition-all hover:scale-105">
                    غير مقروءة
                </button>
                <button (click)="onFilterChange('starred')" [class.bg-amber-600]="selectedFilter === 'starred'"
                    [class.text-white]="selectedFilter === 'starred'" [class.bg-gray-100]="selectedFilter !== 'starred'"
                    [class.text-gray-700]="selectedFilter !== 'starred'"
                    class="px-4 py-2 rounded-xl font-semibold transition-all hover:scale-105">
                    المفضلة
                </button>
                <button (click)="onFilterChange('high')" [class.bg-purple-600]="selectedFilter === 'high'"
                    [class.text-white]="selectedFilter === 'high'" [class.bg-gray-100]="selectedFilter !== 'high'"
                    [class.text-gray-700]="selectedFilter !== 'high'"
                    class="px-4 py-2 rounded-xl font-semibold transition-all hover:scale-105">
                    عاجلة
                </button>
            </div>
        </div>
    </div>

    <!-- Messages List -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden" *ngIf="!isAdmin">
        <!-- Loading State -->
        <div *ngIf="isLoading" class="p-12 text-center">
            <div class="inline-block w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin">
            </div>
            <p class="mt-4 text-gray-600 font-semibold">جاري تحميل الرسائل...</p>
        </div>

        <!-- Messages -->
        <div *ngIf="!isLoading && messages.length > 0" class="divide-y divide-gray-100">
            <div *ngFor="let message of messages" (click)="viewMessage(message)"
                class="p-4 sm:p-6 hover:bg-gray-50 transition-all cursor-pointer group">
                <div class="flex items-start gap-4">
                    <!-- Avatar -->
                    <div class="relative flex-shrink-0">
                        <div
                            class="w-12 h-12 sm:w-14 sm:h-14 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg sm:text-xl">
                            {{ message.senderName.charAt(0) }}
                        </div>
                        <span *ngIf="!message.isRead"
                            class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span>
                    </div>

                    <!-- Content -->
                    <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2 mb-2">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-gray-900 truncate" [class.text-blue-600]="!message.isRead">
                                    {{ message.senderName }}
                                </h3>
                                <p class="text-sm text-gray-500 truncate">{{ message.senderEmail }}</p>
                            </div>
                            <span class="text-xs text-gray-500 whitespace-nowrap">
                                {{ getTimeAgo(message.timestamp) }}
                            </span>
                        </div>

                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-semibold text-gray-800" [class.font-bold]="!message.isRead">
                                {{ message.subject }}
                            </h4>
                            <span class="text-xs px-2 py-0.5 rounded-full font-medium whitespace-nowrap"
                                [ngClass]="getPriorityColor(message.priority)">
                                {{ getPriorityLabel(message.priority) }}
                            </span>
                        </div>

                        <p class="text-sm text-gray-600 line-clamp-2 mb-3">
                            {{ message.content }}
                        </p>

                        <!-- Attachments -->
                        <div *ngIf="message.attachments && message.attachments.length > 0"
                            class="flex items-center gap-2 text-sm text-gray-500">
                            <i class="fas fa-paperclip"></i>
                            <span>{{ message.attachments.length }} مرفق</span>
                        </div>

                        <!-- Actions (shown on hover) -->
                        <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button (click)="markAsRead(message, $event)"
                                class="text-xs px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-colors font-semibold">
                                <i class="fas fa-eye ml-1"></i>
                                {{ message.isRead ? 'غير مقروء' : 'مقروء' }}
                            </button>
                            <button (click)="toggleStar(message, $event)"
                                class="text-xs px-3 py-1.5 rounded-lg hover:bg-amber-100 transition-colors font-semibold"
                                [class.bg-amber-50]="message.isStarred" [class.text-amber-600]="message.isStarred"
                                [class.bg-gray-50]="!message.isStarred" [class.text-gray-600]="!message.isStarred">
                                <i class="fas fa-star ml-1"></i>
                                {{ message.isStarred ? 'إلغاء التمييز' : 'تمييز' }}
                            </button>
                            <button (click)="openDeleteDialog(message, $event)"
                                class="text-xs px-3 py-1.5 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors font-semibold">
                                <i class="fas fa-trash ml-1"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoading && messages.length === 0" class="p-12 text-center">
            <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
                <i class="fas fa-inbox text-5xl text-gray-400"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-700 mb-2">لا توجد رسائل</h3>
            <p class="text-gray-500">ستظهر رسائلك هنا عندما تتلقى رسائل جديدة</p>
        </div>

        <!-- Pagination -->
        <div *ngIf="!isLoading && messages.length > 0" class="p-4 border-t border-gray-100 bg-gray-50">
            <div class="flex items-center justify-between">
                <button (click)="previousPage()" [disabled]="currentPage === 1" [class.opacity-50]="currentPage === 1"
                    [class.cursor-not-allowed]="currentPage === 1"
                    class="px-4 py-2 bg-white border-2 border-gray-200 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition-all disabled:hover:bg-white flex items-center gap-2">
                    <i class="fas fa-chevron-right"></i>
                    <span class="hidden sm:inline">السابق</span>
                </button>

                <span class="text-sm font-semibold text-gray-600">
                    صفحة {{ currentPage }} من {{ totalPages }}
                </span>

                <button (click)="nextPage()" [disabled]="currentPage === totalPages"
                    [class.opacity-50]="currentPage === totalPages"
                    [class.cursor-not-allowed]="currentPage === totalPages"
                    class="px-4 py-2 bg-white border-2 border-gray-200 rounded-xl font-semibold text-gray-700 hover:bg-gray-50 transition-all disabled:hover:bg-white flex items-center gap-2">
                    <span class="hidden sm:inline">التالي</span>
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
        </div>
    </div>

</div>

<!-- View Message Dialog -->
<div *ngIf="isViewDialogOpen && selectedMessage"
    class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 animate-fadeIn"
    style="backdrop-filter: blur(8px);" (click)="closeViewDialog()">

    <div (click)="$event.stopPropagation()"
        class="bg-white rounded-3xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden animate-slideUp">

        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 p-6">
            <div class="flex items-start justify-between">
                <div class="flex items-start gap-4 flex-1">
                    <div
                        class="w-14 h-14 bg-white/20 backdrop-blur-xl rounded-2xl flex items-center justify-center text-white font-bold text-2xl">
                        {{ selectedMessage.senderName.charAt(0) }}
                    </div>
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-white">{{ selectedMessage.senderName }}</h3>
                        <p class="text-white/80 text-sm">{{ selectedMessage.senderEmail }}</p>
                        <p class="text-white/60 text-xs mt-1">{{ getTimeAgo(selectedMessage.timestamp) }}</p>
                    </div>
                </div>
                <button (click)="closeViewDialog()"
                    class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl transition-all flex items-center justify-center">
                    <i class="fas fa-times text-white text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="p-6 overflow-y-auto max-h-[calc(90vh-250px)]">
            <div class="flex items-center gap-2 mb-4">
                <h2 class="text-2xl font-bold text-gray-900">{{ selectedMessage.subject }}</h2>
                <span class="text-sm px-3 py-1 rounded-full font-semibold"
                    [ngClass]="getPriorityColor(selectedMessage.priority)">
                    {{ getPriorityLabel(selectedMessage.priority) }}
                </span>
            </div>

            <div class="prose max-w-none">
                <p class="text-gray-700 whitespace-pre-wrap leading-relaxed">{{ selectedMessage.content }}</p>
            </div>

            <!-- Attachments -->
            <div *ngIf="selectedMessage.attachments && selectedMessage.attachments.length > 0" class="mt-6">
                <h3 class="text-lg font-bold text-gray-900 mb-3">
                    <i class="fas fa-paperclip text-blue-600 ml-2"></i>
                    المرفقات ({{ selectedMessage.attachments.length }})
                </h3>
                <div class="space-y-2">
                    <div *ngFor="let attachment of selectedMessage.attachments"
                        class="flex items-center justify-between p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file text-blue-600"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">{{ attachment.fileName }}</p>
                                <p class="text-xs text-gray-500">{{ formatFileSize(attachment.fileSize) }}</p>
                            </div>
                        </div>
                        <button (click)="downloadAttachment(attachment)"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="border-t border-gray-200 p-4 bg-gray-50 flex items-center justify-between">
            <button (click)="openDeleteDialog(selectedMessage!, $event)"
                class="px-6 py-3 bg-gradient-to-r from-red-600 to-rose-600 text-white rounded-xl hover:shadow-lg transition-all font-semibold flex items-center gap-2">
                <i class="fas fa-trash"></i>
                <span>حذف الرسالة</span>
            </button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Dialog -->
<div *ngIf="isDeleteDialogOpen"
    class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 animate-fadeIn"
    style="backdrop-filter: blur(8px);" (click)="closeDeleteDialog()">

    <div (click)="$event.stopPropagation()"
        class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden animate-slideUp">

        <!-- Header -->
        <div class="bg-gradient-to-r from-red-600 to-rose-600 p-6">
            <div class="flex items-center justify-center">
                <div class="w-16 h-16 bg-white/20 backdrop-blur-xl rounded-full flex items-center justify-center">
                    <i class="fas fa-trash-alt text-white text-3xl"></i>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="p-8 text-center">
            <h2 class="text-2xl font-bold text-gray-900 mb-3">تأكيد الحذف</h2>
            <p class="text-gray-600 mb-2">هل أنت متأكد من حذف هذه الرسالة؟</p>
            <p class="text-sm text-gray-500">لن تتمكن من استرجاعها بعد الحذف</p>

            <div *ngIf="messageToDelete" class="mt-4 p-4 bg-gray-50 rounded-xl text-right">
                <p class="font-semibold text-gray-800 mb-1">{{ messageToDelete.subject }}</p>
                <p class="text-sm text-gray-500">من: {{ messageToDelete.senderName }}</p>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="border-t border-gray-200 p-4 flex items-center gap-3">
            <button (click)="confirmDelete()" [disabled]="isDeleting" [class.opacity-50]="isDeleting"
                [class.cursor-not-allowed]="isDeleting"
                class="flex-1 py-3 bg-gradient-to-r from-red-600 to-rose-600 text-white rounded-xl font-bold hover:shadow-lg transition-all flex items-center justify-center gap-2">
                <i class="fas" [class.fa-trash]="!isDeleting" [class.fa-spinner]="isDeleting"
                    [class.fa-spin]="isDeleting"></i>
                <span>{{ isDeleting ? 'جاري الحذف...' : 'تأكيد الحذف' }}</span>
            </button>
            <button (click)="closeDeleteDialog()" [disabled]="isDeleting"
                class="flex-1 py-3 bg-white border-2 border-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-50 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-times"></i>
                <span>إلغاء</span>
            </button>
        </div>
    </div>
</div>

<!-- Compose Message Dialog -->
<div *ngIf="isComposeDialogOpen"
    class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 animate-fadeIn"
    style="backdrop-filter: blur(8px);" (click)="closeComposeDialog()">

    <div (click)="$event.stopPropagation()"
        class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-hidden animate-slideUp">

        <!-- Header with Gradient -->
        <div class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 p-6 sm:p-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-white/20 backdrop-blur-xl rounded-2xl flex items-center justify-center">
                        <i class="fas fa-paper-plane text-white text-2xl"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-white">رسالة جديدة</h2>
                        <p class="text-white/80 text-sm mt-1">أرسل رسالة للطلاب والمستخدمين</p>
                    </div>
                </div>
                <button (click)="closeComposeDialog()"
                    class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl transition-all flex items-center justify-center group">
                    <i
                        class="fas fa-times text-white text-xl group-hover:rotate-90 transition-transform duration-300"></i>
                </button>
            </div>
        </div>

        <!-- Form Content -->
        <div class="p-6 sm:p-8 overflow-y-auto max-h-[calc(95vh-200px)]">
            <form #composeForm="ngForm">

                <!-- Recipient Type Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        <i class="fas fa-users text-blue-600 ml-2"></i>
                        إرسال إلى
                    </label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <button type="button" (click)="composeData.recipientType = 'all'"
                            [class.bg-gradient-to-r]="composeData.recipientType === 'all'"
                            [class.from-blue-600]="composeData.recipientType === 'all'"
                            [class.to-blue-700]="composeData.recipientType === 'all'"
                            [class.text-white]="composeData.recipientType === 'all'"
                            [class.shadow-lg]="composeData.recipientType === 'all'"
                            [class.bg-gray-100]="composeData.recipientType !== 'all'"
                            [class.text-gray-700]="composeData.recipientType !== 'all'"
                            class="px-4 py-3 rounded-xl font-semibold transition-all hover:scale-105 flex items-center justify-center gap-2">
                            <i class="fas fa-globe"></i>
                            الجميع
                        </button>
                        <button type="button" (click)="composeData.recipientType = 'students'"
                            [class.bg-gradient-to-r]="composeData.recipientType === 'students'"
                            [class.from-purple-600]="composeData.recipientType === 'students'"
                            [class.to-purple-700]="composeData.recipientType === 'students'"
                            [class.text-white]="composeData.recipientType === 'students'"
                            [class.shadow-lg]="composeData.recipientType === 'students'"
                            [class.bg-gray-100]="composeData.recipientType !== 'students'"
                            [class.text-gray-700]="composeData.recipientType !== 'students'"
                            class="px-4 py-3 rounded-xl font-semibold transition-all hover:scale-105 flex items-center justify-center gap-2">
                            <i class="fas fa-user-graduate"></i>
                            الطلاب فقط
                        </button>
                        <button type="button" (click)="composeData.recipientType = 'specific'"
                            [class.bg-gradient-to-r]="composeData.recipientType === 'specific'"
                            [class.from-orange-600]="composeData.recipientType === 'specific'"
                            [class.to-orange-700]="composeData.recipientType === 'specific'"
                            [class.text-white]="composeData.recipientType === 'specific'"
                            [class.shadow-lg]="composeData.recipientType === 'specific'"
                            [class.bg-gray-100]="composeData.recipientType !== 'specific'"
                            [class.text-gray-700]="composeData.recipientType !== 'specific'"
                            class="px-4 py-3 rounded-xl font-semibold transition-all hover:scale-105 flex items-center justify-center gap-2">
                            <i class="fas fa-user-check"></i>
                            مستخدمين محددين
                        </button>
                    </div>
                </div>

                <!-- Specific Users Selection -->
                <div *ngIf="composeData.recipientType === 'specific'" class="mb-6 animate-slideDown">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        <i class="fas fa-user-friends text-orange-600 ml-2"></i>
                        اختر المستخدمين
                    </label>
                    <div class="relative">
                        <input type="text" [(ngModel)]="userSearchTerm" name="userSearch" (input)="searchUsers()"
                            placeholder="ابحث عن مستخدم بالاسم أو البريد الإلكتروني..."
                            class="w-full px-4 py-3 pr-12 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-orange-500 transition-all">
                        <i class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>

                    <!-- Selected Users -->
                    <div *ngIf="composeData.selectedUsers.length > 0" class="mt-3 flex flex-wrap gap-2">
                        <div *ngFor="let user of composeData.selectedUsers"
                            class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-orange-100 to-red-100 rounded-lg border border-orange-300">
                            <div
                                class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center text-white font-bold text-sm">
                                {{ user.firstName.charAt(0) }}
                            </div>
                            <span class="text-sm font-semibold text-gray-700">{{ user.firstName }} {{ user.lastName
                                }}</span>
                            <button type="button" (click)="removeUser(user)"
                                class="w-5 h-5 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center transition-colors">
                                <i class="fas fa-times text-white text-xs"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Available Users List -->
                    <div *ngIf="userSearchTerm && filteredUsers.length > 0"
                        class="mt-3 max-h-48 overflow-y-auto border-2 border-gray-200 rounded-xl">
                        <div *ngFor="let user of filteredUsers" (click)="selectUser(user)"
                            class="p-3 hover:bg-orange-50 cursor-pointer transition-colors flex items-center gap-3 border-b last:border-b-0">
                            <div
                                class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-500 rounded-xl flex items-center justify-center text-white font-bold">
                                {{ user.firstName.charAt(0) }}
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800">{{ user.firstName }} {{ user.lastName }}</p>
                                <p class="text-xs text-gray-500">{{ user.email }}</p>
                            </div>
                            <i class="fas fa-plus-circle text-orange-500 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Priority -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        <i class="fas fa-flag text-red-600 ml-2"></i>
                        الأولوية
                    </label>
                    <div class="grid grid-cols-3 gap-3">
                        <button type="button" (click)="composeData.priority = 'Low'"
                            [class.bg-gradient-to-r]="composeData.priority === 'Low'"
                            [class.from-green-500]="composeData.priority === 'Low'"
                            [class.to-emerald-600]="composeData.priority === 'Low'"
                            [class.text-white]="composeData.priority === 'Low'"
                            [class.shadow-lg]="composeData.priority === 'Low'"
                            [class.bg-green-100]="composeData.priority !== 'Low'"
                            [class.text-green-700]="composeData.priority !== 'Low'"
                            class="px-4 py-3 rounded-xl font-semibold transition-all hover:scale-105">
                            عادي
                        </button>
                        <button type="button" (click)="composeData.priority = 'Medium'"
                            [class.bg-gradient-to-r]="composeData.priority === 'Medium'"
                            [class.from-orange-500]="composeData.priority === 'Medium'"
                            [class.to-amber-600]="composeData.priority === 'Medium'"
                            [class.text-white]="composeData.priority === 'Medium'"
                            [class.shadow-lg]="composeData.priority === 'Medium'"
                            [class.bg-orange-100]="composeData.priority !== 'Medium'"
                            [class.text-orange-700]="composeData.priority !== 'Medium'"
                            class="px-4 py-3 rounded-xl font-semibold transition-all hover:scale-105">
                            متوسط
                        </button>
                        <button type="button" (click)="composeData.priority = 'High'"
                            [class.bg-gradient-to-r]="composeData.priority === 'High'"
                            [class.from-red-500]="composeData.priority === 'High'"
                            [class.to-rose-600]="composeData.priority === 'High'"
                            [class.text-white]="composeData.priority === 'High'"
                            [class.shadow-lg]="composeData.priority === 'High'"
                            [class.bg-red-100]="composeData.priority !== 'High'"
                            [class.text-red-700]="composeData.priority !== 'High'"
                            class="px-4 py-3 rounded-xl font-semibold transition-all hover:scale-105">
                            عاجل
                        </button>
                    </div>
                </div>

                <!-- Subject -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        <i class="fas fa-heading text-indigo-600 ml-2"></i>
                        الموضوع
                        <span class="text-red-500">*</span>
                    </label>
                    <input type="text" [(ngModel)]="composeData.subject" name="subject" required
                        placeholder="أدخل موضوع الرسالة..."
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-all text-lg font-semibold">
                </div>

                <!-- Message Content -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        <i class="fas fa-align-right text-pink-600 ml-2"></i>
                        نص الرسالة
                        <span class="text-red-500">*</span>
                    </label>
                    <textarea [(ngModel)]="composeData.content" name="content" required rows="8"
                        placeholder="اكتب محتوى الرسالة هنا..."
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-pink-500 transition-all resize-none"></textarea>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-xs text-gray-500">{{ composeData.content.length }} حرف</span>
                        <span *ngIf="composeData.content.length < 10" class="text-xs text-red-500">
                            الحد الأدنى 10 أحرف
                        </span>
                    </div>
                </div>

                <!-- Attachments (Optional) -->
                <!-- Attachments (Optional) -->
                <div class="mb-6">
                    <label class="block text-sm font-bold text-gray-700 mb-3">
                        <i class="fas fa-paperclip text-cyan-600 ml-2"></i>
                        المرفقات (اختياري)
                    </label>

                    <!-- Hidden File Input -->
                    <input #fileInput type="file" multiple accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.gif"
                        (change)="onFileSelected($event)" class="hidden">

                    <!-- Upload Area -->
                    <div (click)="fileInput.click()" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
                        (drop)="onFileDrop($event)" [class.border-cyan-500]="isDragging" [class.bg-cyan-50]="isDragging"
                        class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-cyan-500 transition-all cursor-pointer bg-gray-50">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-600 font-semibold">اسحب الملفات هنا أو انقر للتحميل</p>
                        <p class="text-xs text-gray-500 mt-2">PDF, DOC, Images (Max 10MB لكل ملف)</p>
                    </div>

                    <!-- Selected Files Preview -->
                    <div *ngIf="selectedFiles.length > 0" class="mt-4 space-y-2">
                        <div class="flex items-center justify-between text-sm font-semibold text-gray-700 mb-2">
                            <span>الملفات المحددة ({{ selectedFiles.length }})</span>
                            <button type="button" (click)="clearAllFiles()"
                                class="text-red-600 hover:text-red-700 text-xs">
                                <i class="fas fa-times-circle ml-1"></i>
                                حذف الكل
                            </button>
                        </div>
                        <div *ngFor="let file of selectedFiles; let i = index"
                            class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-xl hover:border-cyan-500 transition-all">
                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                <div
                                    class="w-10 h-10 bg-cyan-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas" [ngClass]="getFileIcon(file.name)" class="text-cyan-600"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-semibold text-gray-900 truncate">{{ file.name }}</p>
                                    <p class="text-xs text-gray-500">{{ formatFileSize(file.size) }}</p>
                                </div>
                            </div>
                            <button type="button" (click)="removeFile(i)"
                                class="w-8 h-8 bg-red-50 hover:bg-red-100 rounded-lg flex items-center justify-center transition-colors flex-shrink-0 mr-2">
                                <i class="fas fa-times text-red-600"></i>
                            </button>
                        </div>
                    </div>

                    <!-- File Size Warning -->
                    <div *ngIf="fileSizeError"
                        class="mt-3 p-3 bg-red-50 border border-red-200 rounded-xl flex items-start gap-2">
                        <i class="fas fa-exclamation-triangle text-red-600 mt-0.5"></i>
                        <p class="text-sm text-red-700">{{ fileSizeError }}</p>
                    </div>
                </div>

            </form>
        </div>

        <!-- Footer Actions -->
        <div class="border-t border-gray-200 p-6 bg-gray-50 flex flex-col sm:flex-row items-center gap-3">
            <button (click)="sendMessage()" [disabled]="!isFormValid() || isSending"
                [class.opacity-50]="!isFormValid() || isSending"
                [class.cursor-not-allowed]="!isFormValid() || isSending"
                class="w-full sm:flex-1 py-4 bg-gradient-to-r from-green-600 to-emerald-700 text-white rounded-xl font-bold text-lg hover:shadow-2xl hover:scale-105 transition-all duration-300 flex items-center justify-center gap-3 disabled:hover:scale-100 disabled:hover:shadow-none">
                <i class="fas" [class.fa-paper-plane]="!isSending" [class.fa-spinner]="isSending"
                    [class.fa-spin]="isSending"></i>
                <span>{{ isSending ? 'جاري الإرسال...' : 'إرسال الرسالة' }}</span>
            </button>
            <button (click)="closeComposeDialog()" type="button"
                class="w-full sm:w-auto px-6 py-4 bg-white border-2 border-gray-300 text-gray-700 rounded-xl font-bold text-lg hover:bg-gray-100 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-times"></i>
                <span>إلغاء</span>
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    @keyframes slideDown {
        from {
            transform: translateY(-10px);
            opacity: 0;
        }

        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .animate-fadeIn {
        animation: fadeIn 0.2s ease-out;
    }

    .animate-slideUp {
        animation: slideUp 0.3s ease-out;
    }

    .animate-slideDown {
        animation: slideDown 0.3s ease-out;
    }

    /* Custom Scrollbar */
    .overflow-y-auto::-webkit-scrollbar {
        width: 8px;
    }

    .overflow-y-auto::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .overflow-y-auto::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #10b981, #059669);
        border-radius: 10px;
    }

    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #059669, #047857);
    }
</style>